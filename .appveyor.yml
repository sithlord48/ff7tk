version: '{branch}.{build}'
image: Visual Studio 2019
environment:
  MSVC: 19
  VSVER: 16.0
  configuration: release
  RUNTIME_LINKAGE: static
  ICU_VERSION: 57.1
  ICU_LINKAGE: static
  QT_VERSION: 5.15
  QT_LINKAGE: static
  matrix:
  - platform: x86
    QTDIR: C:\Qt\5.15\msvc2019
    ARCH: x86
    OUTFILE: ff7tk-continuous-win32-msvc2017
  - platform: x64
    QTDIR: C:\Qt\5.15\msvc2019_64
    ARCH: amd64
    OUTFILE: ff7tk-continuous-win64-msvc2017
  - platform: x86
    QTDIR: C:\Qt\5.15\mingw81_32
    ARCH: x86
    OUTFILE: ff7tk-continuous-win32-mingw
  - platform: x64
    QTDIR: C:\Qt\5.15\mingw81_64
    ARCH: amd64
    OUTFILE: ff7tk-continuous-win64-mingw
init:
- ps: >-
    $env:commit = $env:appveyor_repo_commit.SubString(0,7)

    Update-AppveyorBuild -Version ("{0}-{1}-{2}" -f $env:appveyor_repo_branch,$env:appveyor_build_number,$env:commit )
install:
- cmd: >-
    choco install doxygen.install

    %QTDIR%\bin\qtenv2.bat

    if not %QTDIR:msvc=%==%QTDIR% call "%ProgramFiles(x86)%\Microsoft Visual Studio %VSVER%\VC\vcvarsall.bat" %ARCH%

    git clone -q --branch=v1.2.11 https://github.com/madler/zlib c:\projects\zlib

    cd c:\projects\zlib

    cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="C:\zlib" CMakeLists.txt

    ninja install

    refreshenv

    %QTDIR%\bin\qtenv2.bat

    if not %QTDIR:msvc=%==%QTDIR% call "%ProgramFiles(x86)%\Microsoft Visual Studio %VSVER%\VC\vcvarsall.bat" %ARCH%

build_script:
- cmd: >-
    cd c:\projects\ff7tk

    cmake -G Ninja -DDOCS=ON -DWIDGET_GALLERY=ON -DQML_GALLERY=ON -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=%OUTFILE% -DZLIB_ROOT="C:\Program Files\zlib" CMakeLists.txt

    ninja install

    move COPYING.TXT %OUTFILE%\

    copy "C:\zlib\bin\libzlib.dll" %OUTFILE%\bin\

    windeployqt --compiler-runtime --release %OUTFILE%\bin\libff7tk.dll

    windeployqt --compiler-runtime --release %OUTFILE%\bin\ff7tkWidgetGallery.exe

    windeployqt --compiler-runtime --release %OUTFILE%\bin\ff7tkQmlGallery.exe

    7z a -tzip %OUTFILE%.zip %OUTFILE% -r

artifacts:
- path: ff7tk-continuous-*.zip
  name: ff7tk
deploy:
- provider: GitHub
  tag: continuous
  description: continuous
  auth_token:
    secure: yG66EEKasiTmuCDPStbz0nVsvcETsQlnpDD2ScfNWUwT81kKfALCVFRTPMrp6R6E
  artifact: ff7tk
  force_update: true

branches:
  except:
    - continuous
    - gh-pages

